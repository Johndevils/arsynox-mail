<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsynox Mail - Temporary Email Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind CSS with a custom primary color
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for loading spinner and hover effects */
        .loading-spinner {
            border-top-color: #6366F1;
            animation: spinner 1.5s linear infinite;
        }
        
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .email-item {
            transition: all 0.2s ease;
        }
        
        .email-item:hover {
            transform: translateX(5px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Arsynox Mail</h1>
            <p class="text-gray-600">A secure temporary email service powered by api.mail.tm</p>
        </header>

        <main>
            <!-- Email Generation Section -->
            <section class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex-1 w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Temporary Email Address</label>
                        <div class="flex">
                            <input type="text" id="emailAddress" readonly 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:ring-primary focus:border-primary bg-gray-50"
                                placeholder="Click generate to create email">
                            <button id="copyBtn" 
                                class="px-4 py-2 bg-primary text-white rounded-r-md hover:bg-indigo-700 transition-colors">
                                Copy
                            </button>
                        </div>
                    </div>
                    <button id="generateBtn" 
                        class="px-6 py-2 bg-primary text-white rounded-md hover:bg-indigo-700 transition-colors">
                        Generate New Email
                    </button>
                </div>
            </section>

            <!-- Inbox Section -->
            <section class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Inbox</h2>
                    <button id="refreshBtn" 
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
                        Refresh
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="hidden py-8 text-center">
                    <div class="inline-block w-8 h-8 border-4 border-gray-200 rounded-full loading-spinner"></div>
                    <p class="mt-2 text-gray-600">Loading emails...</p>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="hidden py-8 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <p class="text-gray-600">No emails in your inbox yet.</p>
                    <p class="text-sm text-gray-500 mt-1">Generate an email address to start receiving emails.</p>
                </div>
                
                <!-- Email List -->
                <div id="emailList" class="space-y-2">
                    <!-- Emails will be populated here by JavaScript -->
                </div>
                
                <!-- Email Detail View -->
                <div id="emailDetail" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <button id="backBtn" class="mb-4 text-primary hover:text-indigo-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Back to inbox
                    </button>
                    <div class="bg-gray-50 p-4 rounded-md">
                        <h3 id="detailSubject" class="text-lg font-semibold mb-2"></h3>
                        <div class="flex justify-between mb-4">
                            <p id="detailFrom" class="text-sm text-gray-600"></p>
                            <p id="detailDate" class="text-sm text-gray-600"></p>
                        </div>
                        <div id="detailContent" class="prose max-w-none"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // DOM Elements
        const emailAddressEl = document.getElementById('emailAddress');
        const generateBtn = document.getElementById('generateBtn');
        const copyBtn = document.getElementById('copyBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const emailListEl = document.getElementById('emailList');
        const loadingStateEl = document.getElementById('loadingState');
        const emptyStateEl = document.getElementById('emptyState');
        const emailDetailEl = document.getElementById('emailDetail');
        const backBtn = document.getElementById('backBtn');
        const detailSubject = document.getElementById('detailSubject');
        const detailFrom = document.getElementById('detailFrom');
        const detailDate = document.getElementById('detailDate');
        const detailContent = document.getElementById('detailContent');

        // State
        let currentInboxId = '';
        let currentEmail = '';
        let emails = [];

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Try to get existing email and inbox ID from localStorage
            const savedEmail = localStorage.getItem('arsynoxEmail');
            const savedInboxId = localStorage.getItem('arsynoxInboxId');
            
            if (savedEmail && savedInboxId) {
                currentEmail = savedEmail;
                currentInboxId = savedInboxId;
                emailAddressEl.value = currentEmail;
                fetchInbox();
            } else {
                showEmptyState();
            }

            // Add event listeners
            generateBtn.addEventListener('click', generateNewEmail);
            copyBtn.addEventListener('click', copyEmailToClipboard);
            refreshBtn.addEventListener('click', fetchInbox);
            backBtn.addEventListener('click', backToInbox);
        });

        // Generate a new temporary email
        async function generateNewEmail() {
            try {
                showLoadingState();
                const response = await fetch('/api/new');
                const data = await response.json();
                
                if (data.email && data.inboxId) {
                    currentEmail = data.email;
                    currentInboxId = data.inboxId;
                    emailAddressEl.value = currentEmail;
                    localStorage.setItem('arsynoxEmail', currentEmail);
                    localStorage.setItem('arsynoxInboxId', currentInboxId);
                    
                    // Fetch inbox for the new email
                    await fetchInbox();
                } else {
                    showError(data.error || 'Failed to generate email address');
                }
            } catch (error) {
                console.error('Error generating email:', error);
                showError('Error generating email address');
            }
        }

        // Fetch emails for the current address
        async function fetchInbox() {
            if (!currentInboxId) {
                showEmptyState();
                return;
            }

            try {
                showLoadingState();
                const response = await fetch(`/api/inbox?inboxId=${encodeURIComponent(currentInboxId)}`);
                const data = await response.json();
                
                if (data.emails) {
                    emails = data.emails;
                    renderEmailList();
                } else {
                    showError(data.error || 'Failed to fetch emails');
                }
            } catch (error) {
                console.error('Error fetching inbox:', error);
                showError('Error fetching emails');
            }
        }

        // Render the email list
        function renderEmailList() {
            if (emails.length === 0) {
                showEmptyState();
                return;
            }

            hideAllStates();
            emailListEl.innerHTML = '';
            
            // Sort emails by date, newest first
            emails.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            emails.forEach((email, index) => {
                const emailItem = document.createElement('div');
                emailItem.className = 'email-item p-4 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer';
                
                // Format date
                const date = new Date(email.createdAt);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                emailItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate">${email.from || 'Unknown Sender'}</p>
                            <p class="text-sm font-medium text-gray-700 truncate">${email.subject || 'No Subject'}</p>
                            <p class="text-sm text-gray-500 truncate">${email.bodyPreview || 'No preview'}</p>
                        </div>
                        <p class="text-xs text-gray-500 ml-2 whitespace-nowrap">${formattedDate}</p>
                    </div>
                `;
                
                emailItem.addEventListener('click', () => showEmailDetail(index));
                emailListEl.appendChild(emailItem);
            });
        }

        // Show email detail
        function showEmailDetail(index) {
            const email = emails[index];
            
            detailSubject.textContent = email.subject || 'No Subject';
            detailFrom.textContent = `From: ${email.from || 'Unknown Sender'}`;
            
            const date = new Date(email.createdAt);
            detailDate.textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            
            // Process email content
            let content = email.body || 'No content';
            
            // If HTML, display it in an iframe for safety and proper rendering
            if (email.isHTML) {
                detailContent.innerHTML = `<iframe class="w-full h-96 border border-gray-300 rounded" srcdoc="${content.replace(/"/g, '&quot;')}"></iframe>`;
            } else {
                // For plain text, use pre-wrap to preserve formatting
                detailContent.innerHTML = `<pre class="whitespace-pre-wrap">${content}</pre>`;
            }
            
            emailListEl.classList.add('hidden');
            emailDetailEl.classList.remove('hidden');
        }

        // Back to inbox view
        function backToInbox() {
            emailListEl.classList.remove('hidden');
            emailDetailEl.classList.add('hidden');
        }

        // Copy email to clipboard
        function copyEmailToClipboard() {
            if (!currentEmail) return;
            
            navigator.clipboard.writeText(currentEmail)
                .then(() => {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    copyBtn.classList.remove('bg-primary', 'hover:bg-indigo-700');
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        copyBtn.classList.add('bg-primary', 'hover:bg-indigo-700');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showError('Failed to copy email address');
                });
        }

        // UI State Helpers
        function showLoadingState() {
            hideAllStates();
            loadingStateEl.classList.remove('hidden');
        }

        function showEmptyState() {
            hideAllStates();
            emptyStateEl.classList.remove('hidden');
        }

        function hideAllStates() {
            loadingStateEl.classList.add('hidden');
            emptyStateEl.classList.add('hidden');
            emailListEl.innerHTML = '';
            emailDetailEl.classList.add('hidden');
        }

        function showError(message) {
            hideAllStates();
            
            const errorEl = document.createElement('div');
            errorEl.className = 'p-4 bg-red-50 border border-red-200 rounded-md';
            errorEl.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-800">${message}</p>
                    </div>
                </div>
            `;
            
            emailListEl.appendChild(errorEl);
        }
    </script>
</body>
</html>
