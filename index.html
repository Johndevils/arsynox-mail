<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsynox Mail - Temporary Email Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mail-item {
            transition: all 0.3s ease;
        }
        .mail-item:hover {
            transform: translateX(5px);
        }
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-10 fade-in">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
                <i class="fas fa-envelope mr-3"></i>Arsynox Mail
            </h1>
            <p class="text-white/80 text-lg">Free, secure, and disposable temporary email service</p>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Email Address Section -->
            <section class="lg:col-span-1">
                <div class="glass-effect rounded-xl p-6 text-white shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-inbox mr-2"></i> Your Temporary Email
                    </h2>
                    
                    <div class="mb-4">
                        <div class="flex items-center bg-white/10 rounded-lg p-3">
                            <input id="emailAddress" type="text" readonly class="bg-transparent flex-1 outline-none" value="Loading...">
                            <button id="copyBtn" class="ml-2 p-2 hover:bg-white/20 rounded transition">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div id="copyNotification" class="hidden mt-2 text-sm text-green-300">
                            <i class="fas fa-check-circle mr-1"></i> Email copied to clipboard!
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm">Auto-refresh</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input id="autoRefreshToggle" type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm">Refresh every</span>
                            <select id="refreshInterval" class="bg-white/10 rounded px-2 py-1 text-sm outline-none">
                                <option value="5000">5 seconds</option>
                                <option value="10000" selected>10 seconds</option>
                                <option value="30000">30 seconds</option>
                                <option value="60000">1 minute</option>
                            </select>
                        </div>
                    </div>

                    <button id="refreshBtn" class="w-full bg-white/20 hover:bg-white/30 py-2 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh Inbox
                    </button>

                    <button id="newEmailBtn" class="w-full mt-3 bg-purple-600 hover:bg-purple-700 py-2 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Generate New Email
                    </button>

                    <!-- Email Lifetime Extension -->
                    <div class="mt-4 pt-4 border-t border-white/20 text-center">
                        <p class="text-sm text-white/80">This email session expires in:</p>
                        <div id="timerDisplay" class="text-2xl font-bold my-2 text-white">10:00</div>
                        <button id="extendTimeBtn" class="w-full bg-blue-500 hover:bg-blue-600 py-2 px-4 rounded-lg transition flex items-center justify-center">
                            <i class="fas fa-clock mr-2"></i> Add 10 minutes
                        </button>
                    </div>

                    <div class="mt-6 pt-6 border-t border-white/20">
                        <h3 class="font-medium mb-3">How to use</h3>
                        <ol class="text-sm space-y-2 text-white/80">
                            <li>1. Your temporary email is generated automatically</li>
                            <li>2. Use it to register on websites, newsletters, etc.</li>
                            <li>3. Check your inbox here for incoming emails</li>
                            <li>4. Emails are deleted after a certain time</li>
                        </ol>
                    </div>
                </div>
            </section>

            <!-- Inbox Section -->
            <section class="lg:col-span-2">
                <div class="glass-effect rounded-xl p-6 text-white shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 flex items-center justify-between">
                        <span><i class="fas fa-envelope-open-text mr-2"></i> Inbox</span>
                        <span id="emailCount" class="text-sm bg-white/20 px-3 py-1 rounded-full">0 messages</span>
                    </h2>

                    <div id="loadingIndicator" class="flex justify-center py-10">
                        <div class="loading-spinner"></div>
                    </div>

                    <div id="emptyState" class="hidden text-center py-10">
                        <i class="fas fa-inbox text-6xl mb-4 text-white/30"></i>
                        <p id="emptyStateMessage" class="text-white/60">No emails yet. Your inbox is empty.</p>
                    </div>

                    <div id="emailList" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Emails will be loaded here -->
                    </div>
                </div>

                <!-- Email Detail Section -->
                <div id="emailDetail" class="hidden glass-effect rounded-xl p-6 text-white shadow-xl mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">
                            <i class="fas fa-envelope mr-2"></i> Email Details
                        </h2>
                        <button id="closeEmailBtn" class="text-white/70 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="mb-4">
                        <div class="mb-2">
                            <span class="text-sm text-white/70">From:</span>
                            <p id="detailFrom" class="font-medium"></p>
                        </div>
                        <div class="mb-2">
                            <span class="text-sm text-white/70">Subject:</span>
                            <p id="detailSubject" class="font-medium"></p>
                        </div>
                        <div class="mb-4">
                            <span class="text-sm text-white/70">Date:</span>
                            <p id="detailDate" class="font-medium"></p>
                        </div>
                    </div>

                    <div class="border-t border-white/20 pt-4">
                        <div id="detailContent" class="prose prose-invert max-w-none text-white">
                            <!-- Email content will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-white/70 text-sm">
            <p>&copy; 2025 Arsynox Mail.</p>
        </footer>
    </div>

    <script>
        // API configuration
        const API_BASE = 'https://api.mail.tm';
        const EXTEND_DURATION_MS = 10 * 60 * 1000; // 10 minutes
        let currentEmail = null;
        let jwtToken = null;
        let refreshIntervalId = null;
        let lifetimeIntervalId = null;

        // DOM elements
        const emailAddressEl = document.getElementById('emailAddress');
        const copyBtn = document.getElementById('copyBtn');
        const copyNotification = document.getElementById('copyNotification');
        const refreshBtn = document.getElementById('refreshBtn');
        const newEmailBtn = document.getElementById('newEmailBtn');
        const emailListEl = document.getElementById('emailList');
        const emailCountEl = document.getElementById('emailCount');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const emptyState = document.getElementById('emptyState');
        const emptyStateMessage = document.getElementById('emptyStateMessage');
        const emailDetailEl = document.getElementById('emailDetail');
        const closeEmailBtn = document.getElementById('closeEmailBtn');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        const refreshIntervalSelect = document.getElementById('refreshInterval');
        const timerDisplay = document.getElementById('timerDisplay');
        const extendTimeBtn = document.getElementById('extendTimeBtn');

        // Initialize the app
        async function init() {
            const savedAccount = getAccountFromStorage();
            if (savedAccount && savedAccount.expiresAt > Date.now()) {
                await loadExistingEmail(savedAccount);
            } else {
                await generateNewEmail();
            }
            setupEventListeners();
            startAutoRefresh();
        }

        // --- Account Management ---
        function saveAccountToStorage(accountDetails) {
            localStorage.setItem('arsynoxMailAccount', JSON.stringify(accountDetails));
        }

        function getAccountFromStorage() {
            const data = localStorage.getItem('arsynoxMailAccount');
            return data ? JSON.parse(data) : null;
        }

        function clearAccountFromStorage() {
            localStorage.removeItem('arsynoxMailAccount');
        }

        async function loadExistingEmail(account) {
            currentEmail = account.address;
            jwtToken = account.token;
            emailAddressEl.value = currentEmail;
            startLifetimeTimer(account.expiresAt);
            await loadMessages();
        }
        
        async function generateNewEmail() {
            try {
                emailAddressEl.value = 'Generating...';
                newEmailBtn.disabled = true;

                const domainsResponse = await fetch(`${API_BASE}/domains`);
                const domainsData = await domainsResponse.json();
                const domain = domainsData['hydra:member'][0].domain;

                const username = Math.random().toString(36).substring(2, 10);
                currentEmail = `${username}@${domain}`;
                const password = `TempP@ss${Math.random().toString(36).substring(2)}`;

                await fetch(`${API_BASE}/accounts`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address: currentEmail, password})
                });

                const authResponse = await fetch(`${API_BASE}/token`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address: currentEmail, password})
                });
                
                if (!authResponse.ok) throw new Error('Failed to authenticate');

                const authData = await authResponse.json();
                jwtToken = authData.token;

                emailAddressEl.value = currentEmail;
                const expiresAt = Date.now() + EXTEND_DURATION_MS;
                const accountDetails = { address: currentEmail, password, token: jwtToken, expiresAt };
                saveAccountToStorage(accountDetails);
                
                startLifetimeTimer(expiresAt);
                await loadMessages();
            } catch (error) {
                console.error('Error generating email:', error);
                emailAddressEl.value = 'Error generating email';
            } finally {
                newEmailBtn.disabled = false;
            }
        }
        
        // --- Inbox Functionality ---
        async function loadMessages() {
            if (!jwtToken) return;
            const account = getAccountFromStorage();
            if (!account || account.expiresAt <= Date.now()) {
                handleExpiredSession();
                return;
            }

            try {
                loadingIndicator.classList.remove('hidden');
                emailListEl.innerHTML = '';
                emptyState.classList.add('hidden');
                emailDetailEl.classList.add('hidden');

                const response = await fetch(`${API_BASE}/messages`, {
                    headers: {'Authorization': `Bearer ${jwtToken}`}
                });

                if (!response.ok) throw new Error('Failed to fetch messages');

                const data = await response.json();
                const messages = data['hydra:member'];

                emailCountEl.textContent = `${messages.length} message${messages.length !== 1 ? 's' : ''}`;

                if (messages.length === 0) {
                    emptyStateMessage.textContent = 'No emails yet. Your inbox is empty.';
                    emptyState.classList.remove('hidden');
                } else {
                    messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(message => {
                        emailListEl.appendChild(createMessageElement(message));
                    });
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function createMessageElement(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'mail-item bg-white/10 rounded-lg p-4 cursor-pointer hover:bg-white/20 fade-in';
            const date = new Date(message.createdAt).toLocaleString();
            const from = message.from.name || message.from.address;
            const subject = message.subject || '(No subject)';
            
            messageEl.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <div class="font-medium truncate flex-1" title="${from}">${from}</div>
                    <div class="text-xs text-white/60 ml-2 whitespace-nowrap">${date}</div>
                </div>
                <div class="text-sm truncate">${subject}</div>`;
            
            messageEl.addEventListener('click', () => showMessageDetail(message.id));
            return messageEl;
        }

        async function showMessageDetail(messageId) {
            try {
                const response = await fetch(`${API_BASE}/messages/${messageId}`, {
                    headers: {'Authorization': `Bearer ${jwtToken}`}
                });

                if (!response.ok) throw new Error('Failed to fetch message details');
                const message = await response.json();
                
                document.getElementById('detailFrom').textContent = `${message.from.name} <${message.from.address}>`;
                document.getElementById('detailSubject').textContent = message.subject || '(No subject)';
                document.getElementById('detailDate').textContent = new Date(message.createdAt).toLocaleString();
                
                const contentEl = document.getElementById('detailContent');
                if (message.html && message.html.length > 0) {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '400px';
                    iframe.style.border = 'none';
                    iframe.style.background = 'white';
                    iframe.style.borderRadius = '8px';
                    contentEl.innerHTML = '';
                    contentEl.appendChild(iframe);
                    iframe.contentWindow.document.open();
                    iframe.contentWindow.document.write(message.html[0]);
                    iframe.contentWindow.document.close();
                } else {
                    contentEl.innerHTML = `<pre class="whitespace-pre-wrap">${message.text || 'No content available'}</pre>`;
                }
                
                emailDetailEl.classList.remove('hidden');
                emailDetailEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
            } catch (error) {
                console.error('Error fetching message details:', error);
            }
        }

        // --- Timer and Lifetime ---
        function startLifetimeTimer(expiresAt) {
            if (lifetimeIntervalId) clearInterval(lifetimeIntervalId);
            
            function updateTimer() {
                const now = Date.now();
                const remaining = expiresAt - now;

                if (remaining <= 0) {
                    handleExpiredSession();
                } else {
                    const minutes = Math.floor((remaining / 1000) / 60);
                    const seconds = Math.floor((remaining / 1000) % 60);
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    refreshBtn.disabled = false;
                    extendTimeBtn.disabled = false;
                }
            }
            updateTimer();
            lifetimeIntervalId = setInterval(updateTimer, 1000);
        }

        function extendEmailLifetime() {
            const account = getAccountFromStorage();
            if (!account) return;
            
            const newExpiresAt = (account.expiresAt > Date.now() ? account.expiresAt : Date.now()) + EXTEND_DURATION_MS;
            account.expiresAt = newExpiresAt;
            saveAccountToStorage(account);
            startLifetimeTimer(newExpiresAt);
        }

        function handleExpiredSession() {
            clearInterval(lifetimeIntervalId);
            timerDisplay.textContent = 'Expired';
            refreshBtn.disabled = true;
            extendTimeBtn.disabled = true;
            emailListEl.innerHTML = '';
            emailCountEl.textContent = '0 messages';
            emptyStateMessage.textContent = 'Email session has expired. Please generate a new one.';
            emptyState.classList.remove('hidden');
            emailDetailEl.classList.add('hidden');
            stopAutoRefresh();
        }

        // --- Auto-Refresh ---
        function startAutoRefresh() {
            stopAutoRefresh();
            if (autoRefreshToggle.checked) {
                const interval = parseInt(refreshIntervalSelect.value);
                refreshIntervalId = setInterval(loadMessages, interval);
            }
        }

        function stopAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(emailAddressEl.value).then(() => {
                    copyNotification.classList.remove('hidden');
                    setTimeout(() => copyNotification.classList.add('hidden'), 2000);
                });
            });

            refreshBtn.addEventListener('click', loadMessages);
            
            newEmailBtn.addEventListener('click', () => {
                clearAccountFromStorage();
                if (lifetimeIntervalId) clearInterval(lifetimeIntervalId);
                emailDetailEl.classList.add('hidden');
                generateNewEmail();
            });

            extendTimeBtn.addEventListener('click', extendEmailLifetime);
            closeEmailBtn.addEventListener('click', () => emailDetailEl.classList.add('hidden'));
            autoRefreshToggle.addEventListener('change', startAutoRefresh);
            refreshIntervalSelect.addEventListener('change', startAutoRefresh);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
