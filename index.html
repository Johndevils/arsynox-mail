<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsynox Mail - Temporary Disposable Email</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom Scrollbar for Dark Mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }
        .loader {
            border-top-color: #3B82F6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-800 border-b border-slate-700 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-robot text-blue-500 text-2xl"></i>
                <h1 class="text-2xl font-bold tracking-wider text-white">ARSYNOX <span class="text-blue-500">MAIL</span></h1>
            </div>
            <div class="text-sm text-slate-400 hidden sm:block">
                Anonymity Protected
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto flex-grow p-4 max-w-5xl">
        
        <!-- Email Address & Timer Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 mt-6">
            
            <!-- Email Display Card -->
            <div class="md:col-span-2 bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                <h2 class="text-slate-400 text-sm uppercase tracking-wide mb-2 font-semibold">Your Temporary Email Address</h2>
                
                <div class="flex items-center gap-2 bg-slate-900 p-3 rounded-lg border border-slate-700">
                    <input type="text" id="emailDisplay" readonly 
                        class="bg-transparent w-full text-green-400 font-mono text-lg outline-none truncate"
                        value="Generating address...">
                    
                    <button onclick="copyEmail()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded text-white transition group relative">
                        <i class="fa-regular fa-copy"></i>
                        <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">Copy</span>
                    </button>
                </div>
                
                <div class="mt-4 flex justify-between items-center">
                    <button onclick="createNewAccount()" class="text-xs text-slate-500 hover:text-slate-300 underline cursor-pointer">
                        <i class="fa-solid fa-rotate"></i> Generate New Address
                    </button>
                    <span id="status" class="text-xs text-blue-400 font-mono animate-pulse">Connecting...</span>
                </div>
            </div>

            <!-- Timer Card -->
            <div class="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700 flex flex-col justify-center items-center relative">
                <h3 class="text-slate-400 text-xs uppercase mb-2">Session Expires In</h3>
                <div id="timer" class="text-4xl font-bold text-white font-mono mb-3">10:00</div>
                <button onclick="extendTime()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full text-sm font-semibold transition shadow-lg shadow-blue-900/50 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left"></i> Extend (+10m)
                </button>
            </div>
        </div>

        <!-- Inbox Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
            
            <!-- Email List -->
            <div class="lg:col-span-1 bg-slate-800 rounded-xl shadow-lg border border-slate-700 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                    <h3 class="font-bold text-white"><i class="fa-solid fa-inbox mr-2"></i> Inbox</h3>
                    <button onclick="fetchMessages()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-arrows-rotate"></i></button>
                </div>
                <div id="emailList" class="overflow-y-auto flex-grow p-2 space-y-2">
                    <!-- Javascript will populate this -->
                    <div class="text-center text-slate-500 mt-10 text-sm">
                        Waiting for incoming emails...
                    </div>
                </div>
            </div>

            <!-- Email Viewer -->
            <div class="lg:col-span-2 bg-slate-800 rounded-xl shadow-lg border border-slate-700 flex flex-col overflow-hidden relative">
                <!-- Placeholder State -->
                <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600 pointer-events-none">
                    <i class="fa-regular fa-envelope-open text-6xl mb-4 opacity-50"></i>
                    <p>Select an email to read</p>
                </div>

                <!-- Email Header Details -->
                <div id="messageDetails" class="hidden bg-slate-900 p-4 border-b border-slate-700">
                    <h2 id="msgSubject" class="text-lg font-bold text-white mb-1">Subject</h2>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs text-slate-400">From: <span id="msgFrom" class="text-slate-200">sender</span></p>
                            <p class="text-xs text-slate-400">To: <span id="msgTo" class="text-slate-200">me</span></p>
                        </div>
                        <p id="msgDate" class="text-xs text-slate-500">Date</p>
                    </div>
                </div>

                <!-- Email Body Iframe -->
                <div class="flex-grow bg-white relative w-full h-full">
                    <iframe id="messageFrame" class="w-full h-full border-none"></iframe>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-center p-6 text-slate-600 text-sm">
        &copy; 2025 Arsynox Mail. Powered by Mail.tm API.
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // Configuration
        const API_BASE = 'https://api.mail.tm';
        let account = null;
        let token = null;
        let refreshInterval = null;
        
        // Timer Logic
        let timeLeft = 600; // 10 minutes in seconds
        let timerInterval = null;

        // DOM Elements
        const emailInput = document.getElementById('emailDisplay');
        const statusSpan = document.getElementById('status');
        const emailListEl = document.getElementById('emailList');
        const timerDisplay = document.getElementById('timer');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadAccountFromStorage();
            startTimer();
        });

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(timeLeft <= 0) {
                    clearInterval(timerInterval);
                    clearInterval(refreshInterval); // Stop polling
                    timerDisplay.innerText = "EXPIRED";
                    statusSpan.innerText = "Session Expired";
                    statusSpan.className = "text-xs text-red-500 font-mono";
                    return;
                }
                timeLeft--;
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                timerDisplay.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            }, 1000);
        }

        function extendTime() {
            timeLeft = 600; // Reset to 10 mins
            // If polling stopped, restart it
            if(account && token && (!refreshInterval || timeLeft <= 0)) {
                statusSpan.innerText = "Live Polling";
                statusSpan.className = "text-xs text-green-400 font-mono animate-pulse";
                startPolling();
            }
            startTimer(); // Ensure timer is running
        }

        // --- API Interaction ---

        async function loadAccountFromStorage() {
            const storedAccount = localStorage.getItem('arsynox_account');
            const storedToken = localStorage.getItem('arsynox_token');

            if (storedAccount && storedToken) {
                account = JSON.parse(storedAccount);
                token = storedToken;
                emailInput.value = account.address;
                statusSpan.innerText = "Live Polling";
                statusSpan.className = "text-xs text-green-400 font-mono animate-pulse";
                fetchMessages();
                startPolling();
            } else {
                createNewAccount();
            }
        }

        async function createNewAccount() {
            statusSpan.innerText = "Creating ID...";
            statusSpan.className = "text-xs text-yellow-400 font-mono";
            
            // Reset UI
            emailInput.value = "Generating...";
            emailListEl.innerHTML = '<div class="text-center text-slate-500 mt-10 text-sm">Waiting for incoming emails...</div>';
            document.getElementById('messageDetails').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('messageFrame').src = 'about:blank';

            try {
                // 1. Get Domain
                const domainRes = await fetch(`${API_BASE}/domains`);
                const domains = await domainRes.json();
                if(!domains['hydra:member'] || domains['hydra:member'].length === 0) throw new Error("No domains available");
                
                const domain = domains['hydra:member'][0].domain;

                // 2. Create Credentials
                const username = 'arsynox_' + Math.random().toString(36).substring(2, 10);
                const password = Math.random().toString(36).substring(2, 15);
                const address = `${username}@${domain}`;

                // 3. Register
                const regRes = await fetch(`${API_BASE}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });

                if(!regRes.ok) throw new Error("Registration failed");
                const accData = await regRes.json();

                // 4. Login (Get Token)
                const tokenRes = await fetch(`${API_BASE}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });
                
                if(!tokenRes.ok) throw new Error("Login failed");
                const tokenData = await tokenRes.json();

                // Save State
                account = accData;
                token = tokenData.token;
                localStorage.setItem('arsynox_account', JSON.stringify(account));
                localStorage.setItem('arsynox_token', token);

                // Update UI
                emailInput.value = account.address;
                statusSpan.innerText = "Live Polling";
                statusSpan.className = "text-xs text-green-400 font-mono animate-pulse";

                // Reset Timer
                timeLeft = 600;
                startTimer();
                startPolling();

            } catch (error) {
                console.error(error);
                statusSpan.innerText = "Error. Try again.";
                statusSpan.className = "text-xs text-red-500 font-mono";
            }
        }

        function startPolling() {
            if(refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if(token && timeLeft > 0) fetchMessages();
            }, 5000); // Poll every 5 seconds
        }

        async function fetchMessages() {
            if (!token) return;
            
            try {
                const res = await fetch(`${API_BASE}/messages?page=1`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                renderEmailList(data['hydra:member']);
            } catch (error) {
                console.error("Fetch error", error);
            }
        }

        function renderEmailList(messages) {
            if(!messages || messages.length === 0) {
                if(emailListEl.children.length === 0 || emailListEl.innerHTML.includes("Waiting")) {
                     emailListEl.innerHTML = '<div class="text-center text-slate-500 mt-10 text-sm"><i class="fa-regular fa-paper-plane mb-2 block"></i>Inbox empty</div>';
                }
                return;
            }

            // Simple check to avoid re-rendering if nothing changed (optimization)
            // For simplicity in this file, we wipe and rebuild, but in production use IDs
            emailListEl.innerHTML = ''; 

            messages.forEach(msg => {
                const isSeen = msg.seen ? 'opacity-60' : 'font-semibold border-l-4 border-blue-500';
                
                const el = document.createElement('div');
                el.className = `bg-slate-700 hover:bg-slate-600 p-3 rounded cursor-pointer transition ${isSeen}`;
                el.onclick = () => loadMessage(msg.id, msg.from.name || msg.from.address, msg.subject, msg.createdAt);
                
                // Format time
                const date = new Date(msg.createdAt);
                const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                el.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-sm text-white truncate w-2/3">${msg.from.name || msg.from.address}</span>
                        <span class="text-xs text-slate-400">${timeStr}</span>
                    </div>
                    <div class="text-sm text-slate-300 truncate">${msg.subject || '(No Subject)'}</div>
                    <div class="text-xs text-slate-500 mt-1 truncate">${msg.intro || '...'}</div>
                `;
                emailListEl.appendChild(el);
            });
        }

        async function loadMessage(id, from, subject, date) {
            // UI Updates
            document.getElementById('emptyState').classList.add('hidden');
            const details = document.getElementById('messageDetails');
            details.classList.remove('hidden');
            
            document.getElementById('msgSubject').innerText = subject || '(No Subject)';
            document.getElementById('msgFrom').innerText = from;
            document.getElementById('msgTo').innerText = account.address;
            document.getElementById('msgDate').innerText = new Date(date).toLocaleString();

            // Show loader in iframe area temporarily
            // (Skipped for simplicity, keeping old content until loaded)

            try {
                const res = await fetch(`${API_BASE}/messages/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                // Prefer HTML, fallback to text
                const content = data.html && data.html.length > 0 ? data.html : `<pre>${data.text}</pre>`;
                
                const iframe = document.getElementById('messageFrame');
                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(`
                    <style>
                        body { font-family: sans-serif; padding: 20px; color: #333; }
                        a { color: #2563eb; }
                    </style>
                    ${content}
                `);
                doc.close();

                // Mark as seen (API call)
                fetch(`${API_BASE}/messages/${id}`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/merge-patch+json'
                    },
                    body: JSON.stringify({ seen: true })
                });

            } catch (error) {
                console.error(error);
            }
        }

        function copyEmail() {
            const copyText = document.getElementById("emailDisplay");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value);
            
            // Visual feedback handled by CSS hover group mostly, but let's alert briefly
            const btn = document.querySelector("button i.fa-copy").parentElement;
            const originalBg = btn.className;
            btn.classList.remove("bg-slate-700");
            btn.classList.add("bg-green-600");
            setTimeout(() => {
                btn.classList.remove("bg-green-600");
                btn.classList.add("bg-slate-700");
            }, 500);
        }
    </script>
</body>
</html>
